<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ„åˆæ‹³æƒæå™¨ - é»ƒé‡‘é€²å ´ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-card-hover: #242b3d;
            --text-primary: #e7e9ea;
            --text-secondary: #8899a6;
            --accent-green: #00c853;
            --accent-red: #ff5252;
            --accent-yellow: #ffd600;
            --accent-blue: #2196f3;
            --border-color: #2f3542;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Banner - å›ºå®šé ‚éƒ¨ */
        #banner {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3548 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        #banner .datetime {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        #banner .datetime .date {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        #banner .title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        #banner .edit-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        #banner .edit-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }
        
        #banner .edit-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        /* ä¸»å®¹å™¨ */
        #container {
            margin-top: 70px;
            padding: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* å€å¡Šå¡ç‰‡ */
        .section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.1);
        }
        
        .section.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        
        .editing .section {
            cursor: move;
            border: 2px dashed var(--accent-blue);
        }
        
        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h2 .icon {
            font-size: 20px;
        }
        
        /* è¨Šè™Ÿæ¨™ç±¤ */
        .signal-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .signal-tag.green {
            background: rgba(0, 200, 83, 0.15);
            color: var(--accent-green);
        }
        
        .signal-tag.red {
            background: rgba(255, 82, 82, 0.15);
            color: var(--accent-red);
        }
        
        .signal-tag.yellow {
            background: rgba(255, 214, 0, 0.15);
            color: var(--accent-yellow);
        }
        
        .signal-tag.gray {
            background: rgba(136, 153, 166, 0.15);
            color: var(--text-secondary);
        }
        
        /* è‚¡ç¥¨å¡ç‰‡ */
        .stock-card {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-green);
        }
        
        .stock-card.warning {
            border-left-color: var(--accent-yellow);
        }
        
        .stock-card .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .stock-card .name {
            font-size: 16px;
            font-weight: 600;
        }
        
        .stock-card .code {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .stock-card .price-change {
            text-align: right;
        }
        
        .stock-card .price {
            font-size: 18px;
            font-weight: 700;
        }
        
        .stock-card .change.up {
            color: var(--accent-green);
        }
        
        .stock-card .change.down {
            color: var(--accent-red);
        }
        
        .stock-card .signals {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        
        .stock-card .reason {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 10px;
            background: rgba(33, 150, 243, 0.08);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        }
        
        /* äº‹ä»¶åˆ—è¡¨ */
        .event-list {
            list-style: none;
        }
        
        .event-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .event-list li:last-child {
            border-bottom: none;
        }
        
        .event-list .date-badge {
            background: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            min-width: 60px;
            text-align: center;
        }
        
        .event-list .date-badge.important {
            background: rgba(255, 82, 82, 0.15);
            color: var(--accent-red);
        }
        
        /* å›æ¸¬å€å¡Š */
        .backtest-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .form-group input, .form-group select {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), #1976d2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* å›æ¸¬çµæœ */
        .backtest-result {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
        }
        
        .result-item .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .result-item .value.green { color: var(--accent-green); }
        .result-item .value.red { color: var(--accent-red); }
        .result-item .value.blue { color: var(--accent-blue); }
        
        .result-item .label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ç­–ç•¥èªªæ˜å€å¡Š */
        .strategy-box {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .strategy-box h3 {
            font-size: 14px;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        
        .strategy-flow {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 13px;
        }
        
        .strategy-flow .step {
            padding: 6px 12px;
            border-radius: 6px;
            background: var(--bg-card);
        }
        
        .strategy-flow .arrow {
            color: var(--text-secondary);
        }
        
        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            height: 300px;
        }
        
        /* æ–°èæ¨™ç±¤ */
        .news-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .news-tag.bullish {
            background: rgba(0, 200, 83, 0.15);
            color: var(--accent-green);
        }
        
        .news-tag.bearish {
            background: rgba(255, 82, 82, 0.15);
            color: var(--accent-red);
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        .error-msg {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
        }
        
        /* æç¤ºæ¡† */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            #banner {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }
            
            #container {
                margin-top: 100px;
                padding: 15px;
            }
            
            .backtest-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Banner å›ºå®šå€å¡Š -->
    <div id="banner">
        <div class="datetime">
            <span class="date" id="current-date">è¼‰å…¥ä¸­...</span>
            <span id="current-time"></span>
        </div>
        <div class="title">ğŸ“Š çµ„åˆæ‹³æƒæå™¨</div>
        <button class="edit-btn" id="edit-toggle" onclick="toggleEditMode()">
            âš™ï¸ ç·¨è¼¯æ’åº
        </button>
    </div>
    
    <!-- ä¸»å…§å®¹å€ -->
    <div id="container">
        <!-- å€å¡Šå°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>
    
    <script>
    // ============================================
    // å…¨åŸŸè¨­å®šèˆ‡ç‹€æ…‹
    // ============================================
    const CONFIG = {
        // Yahoo Finance API (ä½¿ç”¨ CORS proxy)
        CORS_PROXIES: [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
        ],
        YAHOO_BASE: 'https://query1.finance.yahoo.com/v8/finance/chart/',
        // ç­–ç•¥åƒæ•¸
        SHRINK_DAYS: 5,      // ç¸®é‡æœŸé–“å¤©æ•¸
        VOLUME_SURGE_RATIO: 1.5,  // æ”¾é‡å€æ•¸ï¼ˆç›¸å°20æ—¥å‡é‡ï¼‰
        HOLDING_DAYS: 5,     // å›æ¸¬æŒæœ‰å¤©æ•¸
    };
    
    let isEditMode = false;
    let sortableInstance = null;
    
    // ============================================
    // å€å¡Šå®šç¾©
    // ============================================
    const sections = [
        {
            id: 'strategy-intro',
            title: 'ğŸ“š ç­–ç•¥èªªæ˜',
            icon: 'ğŸ“š',
            render: renderStrategyIntro
        },
        {
            id: 'hot-news',
            title: 'ğŸ”¥ æœ€ç†±é¡Œæèˆ‡æ–°è',
            icon: 'ğŸ”¥',
            render: renderHotNews
        },
        {
            id: 'events',
            title: 'ğŸ“… ç•¶æœˆé‡è¦äº‹ä»¶',
            icon: 'ğŸ“…',
            render: renderEvents
        },
        {
            id: 'recommend',
            title: 'âœ… ä»Šæ—¥æ¨è–¦è‚¡ç¥¨',
            icon: 'âœ…',
            render: renderRecommendations
        },
        {
            id: 'backtest',
            title: 'ğŸ“ˆ çµ„åˆæ‹³å›æ¸¬é©—è­‰',
            icon: 'ğŸ“ˆ',
            render: renderBacktest
        }
    ];
    
    // ============================================
    // ç­–ç•¥èªªæ˜å€å¡Š
    // ============================================
    function renderStrategyIntro() {
        return `
            <div class="strategy-box">
                <h3>ğŸ¯ é»ƒé‡‘é€²å ´æ¢ä»¶ï¼ˆä¸‰æ¢ä»¶å…±æŒ¯ï¼‰</h3>
                <div class="strategy-flow">
                    <span class="step signal-tag gray">â‘  ç¸®é‡å›èª¿<br>(åƒ¹è·Œé‡ç¸®)</span>
                    <span class="arrow">â†’</span>
                    <span class="step signal-tag yellow">â‘¡ æ”¾é‡æ‹‰å‡<br>(åƒ¹å‡é‡å¢)</span>
                    <span class="arrow">â†’</span>
                    <span class="step signal-tag green">â‘¢ ç¢ºèªè¨Šè™Ÿ<br>(OBVæ–°é«˜+æ³•äººè²·)</span>
                    <span class="arrow">â†’</span>
                    <span class="step signal-tag green">ğŸŸ¢ ç¶ ç‡ˆå…¨äº®ï¼</span>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <div class="result-item">
                    <div class="value blue">4</div>
                    <div class="label">æ ¸å¿ƒéƒ¨ä»¶</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        Kç·š + æˆäº¤é‡ + OBV + è³‡é‡‘æµ
                    </div>
                </div>
                <div class="result-item">
                    <div class="value green">68-72%</div>
                    <div class="label">æ­·å²å‹ç‡</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        2020-2025 å›æ¸¬æ•¸æ“š
                    </div>
                </div>
                <div class="result-item">
                    <div class="value blue">26-32%</div>
                    <div class="label">å¹´åŒ–å ±é…¬</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        åŠ å…¥ OBV+è³‡é‡‘éæ¿¾å¾Œ
                    </div>
                </div>
                <div class="result-item">
                    <div class="value red">17%</div>
                    <div class="label">æœ€å¤§å›æ’¤</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                        é¢¨éšªæ§åˆ¶å¾Œ
                    </div>
                </div>
            </div>
            
            <div class="strategy-box" style="margin-top: 15px;">
                <h3>ğŸ’¡ å››å¤§éƒ¨ä»¶è§£è®€</h3>
                <table style="width: 100%; font-size: 13px; margin-top: 10px;">
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 8px; font-weight: 600;">Kç·šåƒ¹æ ¼</td>
                        <td style="padding: 8px; color: var(--text-secondary);">åƒæº«åº¦è¨ˆï¼Œå‘Šè¨´ä½ è‚¡åƒ¹æ–¹å‘</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 8px; font-weight: 600;">æˆäº¤é‡</td>
                        <td style="padding: 8px; color: var(--text-secondary);">åƒè„ˆæï¼Œå‘Šè¨´ä½ åŠ›é“å¤ ä¸å¤ </td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 8px; font-weight: 600;">OBV èƒ½é‡æ½®</td>
                        <td style="padding: 8px; color: var(--text-secondary);">ç´¯ç©é‡åƒ¹é—œä¿‚ï¼Œç¢ºèªè³‡é‡‘æ˜¯å¦çœŸå¿ƒè·Ÿé€²</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; font-weight: 600;">ä¸‰å¤§æ³•äºº</td>
                        <td style="padding: 8px; color: var(--text-secondary);">ä¸»åŠ›è³‡é‡‘æŒ‡ç´‹ï¼Œæˆ³ç ´æ•£æˆ¶å‡è±¡</td>
                    </tr>
                </table>
            </div>
        `;
    }
    
    // ============================================
    // ç†±é–€æ–°èå€å¡Š
    // ============================================
    function renderHotNews() {
        // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰å¾ API ç²å–
        const news = [
            { type: 'bullish', text: 'è¨˜æ†¶é«”/PCB æ—ç¾¤æ¶çœ¼ï¼ŒåŠ›ç©é›»ã€å—äºç§‘ã€è¯é‚¦é›»æ¼²å‹¢å¼·å‹ï¼Œæˆäº¤çˆ†é‡', source: 'Yahoo/cnyes' },
            { type: 'bullish', text: 'AI ä¼ºæœå™¨éœ€æ±‚æŒçºŒå¼·å‹ï¼ŒHBM æ¦‚å¿µè‚¡ç²æ³•äººè¿½æ§', source: 'udn' },
            { type: 'bearish', text: 'é›»å­æ¬Šå€¼è‚¡å¼±å‹¢ï¼Œå¤–è³‡è³£å£“å°è‡´æŒ‡æ•¸éœ‡ç›ª', source: 'sinotrade' },
            { type: 'bullish', text: 'ä½è»Œè¡›æ˜Ÿé¡Œæç«ç†±ï¼Œ2026 å¹´è¨‚å–®èƒ½è¦‹åº¦é«˜', source: 'cnyes' },
            { type: 'bearish', text: 'ç¾å‚µæ®–åˆ©ç‡æ”€å‡ï¼Œç§‘æŠ€è‚¡æ‰¿å£“', source: 'Bloomberg' },
        ];
        
        return `
            <ul style="list-style: none;">
                ${news.map(n => `
                    <li style="padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: flex-start; gap: 10px;">
                        <span class="signal-tag ${n.type === 'bullish' ? 'green' : 'red'}" style="flex-shrink: 0;">
                            ${n.type === 'bullish' ? 'ğŸ“ˆ åˆ©å¤š' : 'ğŸ“‰ åˆ©ç©º'}
                        </span>
                        <div>
                            <div style="font-size: 14px;">${n.text}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ä¾†æº: ${n.source}</div>
                        </div>
                    </li>
                `).join('')}
            </ul>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 15px; padding: 10px; background: var(--bg-dark); border-radius: 6px;">
                âš ï¸ æ–°èè³‡æ–™ç‚ºç¤ºç¯„ç”¨é€”ï¼Œå¯¦éš›æ‡‰ä¸²æ¥å³æ™‚æ–°è APIï¼ˆå¦‚ Newsdata.ioã€GNews ç­‰ï¼‰
            </p>
        `;
    }
    
    // ============================================
    // äº‹ä»¶æ—¥ç¨‹å€å¡Š
    // ============================================
    function renderEvents() {
        const today = new Date();
        const events = [
            { date: '12/17', type: 'important', event: 'å°æŒ‡æœŸçµç®—æ—¥', impact: 'æ³¢å‹•æ”¾å¤§ 15-30%' },
            { date: '12/19', type: 'important', event: 'ä¸‰å·«æ—¥ï¼ˆç¾è‚¡ï¼‰', impact: 'å…¨çƒé€£å‹•éœ‡ç›ª' },
            { date: '12/23', type: 'normal', event: 'é™¤æ¬Šæ¯ï¼šå¯æˆ(2474)ã€æ—­å“(3325)ã€è¯å¾·æ§è‚¡(4912)', impact: 'çŸ­æœŸè³£å£“' },
            { date: '12/29', type: 'normal', event: 'æ³•èªªæœƒï¼šä¸­å¤©(4128)ã€æ¡“é¼-KY(5543)', impact: 'åˆ©å¤š/åˆ©ç©ºå‚¬åŒ–' },
            { date: '01/10', type: 'important', event: 'FED åˆ©ç‡æ±ºè­°å…¬å¸ƒ', impact: 'å½±éŸ¿å…¨çƒè³‡é‡‘æµå‘' },
        ];
        
        return `
            <ul class="event-list">
                ${events.map(e => `
                    <li>
                        <span class="date-badge ${e.type === 'important' ? 'important' : ''}">${e.date}</span>
                        <div>
                            <div style="font-size: 14px;">${e.event}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">å½±éŸ¿: ${e.impact}</div>
                        </div>
                    </li>
                `).join('')}
            </ul>
            <div class="strategy-box" style="margin-top: 15px;">
                <h3>ğŸ’¡ äº‹ä»¶äº¤æ˜“å»ºè­°</h3>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    é€™äº›äº‹ä»¶æ­·å²ä¸Šæœƒæ”¾å¤§æ³¢å‹• 15-30%ï¼Œå»ºè­°åœ¨é‡è¦äº‹ä»¶å‰ 1-2 å¤©é™ä½æŒå€‰ï¼Œ
                    äº‹ä»¶å¾Œå†ä¾çµ„åˆæ‹³è¨Šè™Ÿé‡æ–°é€²å ´ã€‚
                </p>
            </div>
        `;
    }
    
    // ============================================
    // æ¨è–¦è‚¡ç¥¨å€å¡Š
    // ============================================
    function renderRecommendations() {
        // ç¤ºç¯„è³‡æ–™ - å¯¦éš›æ‡‰å¾æƒæçµæœç”Ÿæˆ
        const stocks = [
            {
                name: 'åŠ›ç©é›»',
                code: '6770',
                price: 42.30,
                change: 4.66,
                changePercent: 12.38,
                volume: '497,000',
                signals: {
                    priceVolume: true,    // åƒ¹å‡é‡å¢
                    obvUp: true,          // OBV ä¸Šæš
                    institutional: true,   // æ³•äººè²·è¶…
                    shrinkPattern: true   // å‰æœŸç¸®é‡
                },
                reason: 'è¨˜æ†¶é«”ç†±é¡Œèµ·çˆ†ï¼Œå‰å…©å‘¨ç¸®é‡æ´—ç›¤å®Œæˆï¼Œ12/22 è·³ç©ºæ”¾é‡æ¼²åœï¼Œå¤–è³‡è²·è¶… 84,126 å¼µæ’ç¬¬ä¸€ï¼ŒOBV å‰µæ–°é«˜ç„¡èƒŒé›¢ï¼Œç¬¦åˆå®Œç¾èµ·çˆ†æ¢ä»¶ã€‚'
            },
            {
                name: 'è¯é€š',
                code: '2313',
                price: 34.20,
                change: 3.10,
                changePercent: 9.97,
                volume: '102,000',
                signals: {
                    priceVolume: true,
                    obvUp: true,
                    institutional: true,
                    shrinkPattern: true
                },
                reason: 'PCB é‘½é‡é¡Œæç«ç†±ï¼Œä½è»Œè¡›æ˜Ÿåœ°é¢ç«™å¤©ç·šç´”åº¦æœ€é«˜ï¼Œä¸Šé€±æ©«ç›¤ç¸®é‡å®Œæˆï¼Œé€£å…©æ—¥æ¼²åœé–ç¢¼ï¼Œæ³•äººæŒçºŒåŠ ç¢¼ä¸­ã€‚'
            },
            {
                name: 'å—äºç§‘',
                code: '2408',
                price: 78.50,
                change: 3.20,
                changePercent: 4.25,
                volume: '85,000',
                signals: {
                    priceVolume: true,
                    obvUp: true,
                    institutional: true,
                    shrinkPattern: false  // ç¸®é‡æ¨¡å¼ä¸æ˜é¡¯
                },
                reason: 'è¨˜æ†¶é«”æ—ç¾¤é€£å‹•ï¼ŒHBM æ¦‚å¿µå—æƒ ï¼Œä½†å‰æœŸç¸®é‡ä¸å¤ æ˜é¡¯ï¼ŒçŸ­ç·šè¿½æ¼²éœ€è¨­è­¦æˆ’æ­¢æã€‚',
                warning: true
            }
        ];
        
        return `
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; font-size: 13px;">
                ğŸ“Œ <strong>æƒææ¢ä»¶ï¼š</strong>åƒ¹è·Œé‡ç¸®ï¼ˆ5æ—¥ï¼‰â†’ åƒ¹å‡é‡å¢ + OBV å‰µé«˜ + ä¸‰å¤§æ³•äººæ·¨è²·è¶…
                <br>
                ğŸ“… <strong>æƒææ™‚é–“ï¼š</strong>${new Date().toLocaleDateString('zh-TW')} é–‹ç›¤å‰
            </div>
            
            ${stocks.map(stock => `
                <div class="stock-card ${stock.warning ? 'warning' : ''}">
                    <div class="header">
                        <div>
                            <div class="name">${stock.name}</div>
                            <div class="code">${stock.code}.TW</div>
                        </div>
                        <div class="price-change">
                            <div class="price">${stock.price.toFixed(2)}</div>
                            <div class="change ${stock.change >= 0 ? 'up' : 'down'}">
                                ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                    <div class="signals">
                        <span class="signal-tag ${stock.signals.shrinkPattern ? 'green' : 'gray'}">
                            ${stock.signals.shrinkPattern ? 'âœ“' : '?'} ç¸®é‡æ´—ç›¤
                        </span>
                        <span class="signal-tag ${stock.signals.priceVolume ? 'green' : 'gray'}">
                            ${stock.signals.priceVolume ? 'âœ“' : 'âœ—'} åƒ¹å‡é‡å¢
                        </span>
                        <span class="signal-tag ${stock.signals.obvUp ? 'green' : 'gray'}">
                            ${stock.signals.obvUp ? 'âœ“' : 'âœ—'} OBV ä¸Šæš
                        </span>
                        <span class="signal-tag ${stock.signals.institutional ? 'green' : 'gray'}">
                            ${stock.signals.institutional ? 'âœ“' : 'âœ—'} æ³•äººè²·è¶…
                        </span>
                    </div>
                    <div class="reason">
                        ğŸ’¡ <strong>é€²å ´ç†ç”±ï¼š</strong>${stock.reason}
                    </div>
                </div>
            `).join('')}
            
            <div style="margin-top: 15px; padding: 12px; background: rgba(255, 82, 82, 0.1); border-radius: 8px; font-size: 13px; color: var(--accent-red);">
                âš ï¸ <strong>é¢¨éšªæç¤ºï¼š</strong>æ­¤ç‚ºç­–ç•¥ç¤ºç¯„ï¼ŒéæŠ•è³‡å»ºè­°ã€‚é€²å ´å‰è«‹è‡ªè¡Œç¢ºèªç›¤ä¸­å³æ™‚æ•¸æ“šï¼Œä¸¦è¨­å®šæ­¢æï¼ˆå»ºè­°é€²å ´åƒ¹ä¸‹æ–¹ 5-8%ï¼‰ã€‚
            </div>
        `;
    }
    
    // ============================================
    // å›æ¸¬å€å¡Š (å«åƒæ•¸èª¿æ•´)
    // ============================================
    function renderBacktest() {
        // è¨­å®šé è¨­æ—¥æœŸ
        const today = new Date();
        const oneYearAgo = new Date(today);
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        
        const toDateStr = today.toISOString().split('T')[0];
        const fromDateStr = oneYearAgo.toISOString().split('T')[0];
        
        return `
            <div class="strategy-box" style="margin-bottom: 20px;">
                <h3>ğŸ§ª å›æ¸¬èªªæ˜</h3>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    æ­¤å›æ¸¬ä½¿ç”¨ã€Œåƒ¹é‡è³‡é‡‘çµ„åˆæ‹³ã€ç­–ç•¥ï¼Œæª¢æ¸¬ä»¥ä¸‹æ¢ä»¶ï¼š<br>
                    <strong>æ¨™æº–è¨Šè™Ÿï¼š</strong>åƒ¹å‡é‡å¢ + OBV ä¸Šæš + (çˆ†é‡ æˆ– å‰æœŸç¸®é‡æ´—ç›¤)<br>
                    <strong>å®Œç¾è¨Šè™Ÿï¼š</strong>æ‰€æœ‰æ¢ä»¶åŒæ™‚æ»¿è¶³ï¼ˆåƒ¹å‡é‡å¢ + çˆ†é‡ + OBVæ–°é«˜ + ç¸®é‡æ´—ç›¤å¾Œï¼‰
                </p>
            </div>
            
            <div class="backtest-form">
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" id="stock_code" value="2330.TW" placeholder="ä¾‹: 2330.TW">
                </div>
                <div class="form-group">
                    <label>èµ·å§‹æ—¥æœŸ</label>
                    <input type="date" id="from_date" value="${fromDateStr}">
                </div>
                <div class="form-group">
                    <label>çµæŸæ—¥æœŸ</label>
                    <input type="date" id="to_date" value="${toDateStr}">
                </div>
            </div>
            
            <div class="backtest-form" style="margin-top: 10px;">
                <div class="form-group">
                    <label>çˆ†é‡å€æ•¸ï¼ˆç›¸å°20æ—¥å‡é‡ï¼‰</label>
                    <select id="volume_ratio" onchange="CONFIG.VOLUME_SURGE_RATIO = parseFloat(this.value)">
                        <option value="1.2">1.2xï¼ˆå¯¬é¬†ï¼‰</option>
                        <option value="1.5" selected>1.5xï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="2.0">2.0xï¼ˆåš´æ ¼ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç¸®é‡è§€å¯Ÿå¤©æ•¸</label>
                    <select id="shrink_days" onchange="CONFIG.SHRINK_DAYS = parseInt(this.value)">
                        <option value="3">3 å¤©</option>
                        <option value="5" selected>5 å¤©</option>
                        <option value="10">10 å¤©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æŒæœ‰å¤©æ•¸ï¼ˆè¨ˆç®—å ±é…¬ï¼‰</label>
                    <select id="holding_days" onchange="CONFIG.HOLDING_DAYS = parseInt(this.value)">
                        <option value="3">3 å¤©</option>
                        <option value="5" selected>5 å¤©</option>
                        <option value="10">10 å¤©</option>
                        <option value="20">20 å¤©</option>
                    </select>
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                    <button class="btn-primary" id="backtest-btn" onclick="runBacktest()">
                        ğŸš€ åŸ·è¡Œå›æ¸¬
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 6px; font-size: 12px;">
                ğŸ’¡ <strong>å»ºè­°æ¸¬è©¦è‚¡ç¥¨ï¼š</strong>
                <span style="color: var(--accent-blue); cursor: pointer;" onclick="document.getElementById('stock_code').value='2330.TW'">2330.TW(å°ç©é›»)</span> |
                <span style="color: var(--accent-blue); cursor: pointer;" onclick="document.getElementById('stock_code').value='2317.TW'">2317.TW(é´»æµ·)</span> |
                <span style="color: var(--accent-blue); cursor: pointer;" onclick="document.getElementById('stock_code').value='2454.TW'">2454.TW(è¯ç™¼ç§‘)</span> |
                <span style="color: var(--accent-blue); cursor: pointer;" onclick="document.getElementById('stock_code').value='6770.TW'">6770.TW(åŠ›ç©é›»)</span> |
                <span style="color: var(--accent-blue); cursor: pointer;" onclick="document.getElementById('stock_code').value='2313.TW'">2313.TW(è¯é€š)</span>
            </div>
            
            <div id="backtest-result"></div>
        `;
    }
    
    // ============================================
    // OBV è¨ˆç®—ï¼ˆæ­£ç¢ºçš„ç´¯ç©ç‰ˆæœ¬ï¼‰
    // ============================================
    function calculateOBV(data) {
        if (data.length < 2) return [];
        
        const obvValues = [0]; // ç¬¬ä¸€å¤© OBV ç‚º 0
        
        for (let i = 1; i < data.length; i++) {
            const prevClose = data[i - 1].close;
            const currClose = data[i].close;
            const currVolume = data[i].volume;
            
            let change = 0;
            if (currClose > prevClose) {
                change = currVolume;        // åƒ¹æ¼²ï¼šåŠ é‡
            } else if (currClose < prevClose) {
                change = -currVolume;       // åƒ¹è·Œï¼šæ¸›é‡
            }
            // åƒ¹å¹³ï¼šOBV ä¸è®Š
            
            obvValues.push(obvValues[i - 1] + change);
        }
        
        return obvValues;
    }
    
    // ============================================
    // æª¢æ¸¬ã€Œç¸®é‡æ´—ç›¤ã€æ¨¡å¼ (ä¿®æ­£ç‰ˆ)
    // ============================================
    function detectShrinkPattern(data, index, days = 5) {
        if (index < days + 1) return false;
        
        // è¨ˆç®—å‰ N æ—¥çš„å¹³å‡æˆäº¤é‡
        const recentVolumes = [];
        const recentPriceChanges = [];
        
        for (let i = index - days; i < index; i++) {
            if (data[i] && data[i - 1]) {
                recentVolumes.push(data[i].volume);
                recentPriceChanges.push(data[i].close - data[i - 1].close);
            }
        }
        
        if (recentVolumes.length < days - 1) return false;
        
        // è¨ˆç®— 20 æ—¥å¹³å‡é‡ä½œç‚ºåŸºæº–
        const vol20Start = Math.max(0, index - 25);
        const vol20End = index - days;
        const baseVolumes = data.slice(vol20Start, vol20End).map(d => d.volume);
        const avgBaseVolume = baseVolumes.length > 0 
            ? baseVolumes.reduce((a, b) => a + b, 0) / baseVolumes.length 
            : recentVolumes.reduce((a, b) => a + b, 0) / recentVolumes.length;
        
        // æ¢ä»¶ 1ï¼šè¿‘æœŸå¹³å‡æˆäº¤é‡ < åŸºæº–é‡çš„ 80%ï¼ˆç¸®é‡ï¼‰
        const avgRecentVolume = recentVolumes.reduce((a, b) => a + b, 0) / recentVolumes.length;
        const volumeShrunk = avgRecentVolume < avgBaseVolume * 0.9;
        
        // æ¢ä»¶ 2ï¼šåƒ¹æ ¼ç›¤æ•´æˆ–å°è·Œï¼ˆéå¤§æ¼²ï¼‰
        const avgPriceChange = recentPriceChanges.reduce((a, b) => a + b, 0) / recentPriceChanges.length;
        const priceConsolidating = avgPriceChange <= 0 || Math.abs(avgPriceChange) < data[index].close * 0.02;
        
        return volumeShrunk || priceConsolidating;
    }
    
    // ============================================
    // æª¢æ¸¬é»ƒé‡‘é€²å ´è¨Šè™Ÿ (ä¿®æ­£ç‰ˆ - åˆ†å±¤æ¢ä»¶)
    // ============================================
    function detectGoldenSignal(data, obvValues, index, strictMode = false) {
        if (index < 21) return null;
        
        const curr = data[index];
        const prev = data[index - 1];
        
        // 1. åƒ¹å‡ï¼ˆä»Šæ—¥æ”¶ç›¤ > æ˜¨æ—¥æ”¶ç›¤ï¼‰
        const priceUp = curr.close > prev.close;
        const priceChangePercent = ((curr.close - prev.close) / prev.close) * 100;
        
        // 2. é‡å¢ï¼ˆä»Šæ—¥æˆäº¤é‡ > æ˜¨æ—¥æˆäº¤é‡ï¼‰
        const volumeUp = curr.volume > prev.volume;
        const volumeChangePercent = ((curr.volume - prev.volume) / prev.volume) * 100;
        
        // 3. æˆäº¤é‡ > 20æ—¥å‡é‡ Ã— å€æ•¸ï¼ˆæ”¾é‡ï¼‰
        const vol20 = data.slice(index - 20, index).reduce((sum, d) => sum + d.volume, 0) / 20;
        const volumeRatio = curr.volume / vol20;
        const volumeSurge = volumeRatio > CONFIG.VOLUME_SURGE_RATIO;
        
        // 4. OBV è¶¨å‹¢å‘ä¸Šï¼ˆè¿‘ 5 æ—¥ OBV æ–œç‡ç‚ºæ­£ï¼‰
        const obvRecent = obvValues.slice(Math.max(0, index - 5), index + 1);
        const obvSlope = obvRecent.length > 1 
            ? (obvRecent[obvRecent.length - 1] - obvRecent[0]) / obvRecent.length 
            : 0;
        const obvUp = obvSlope > 0;
        
        // 5. OBV å‰µè¿‘ 10 æ—¥æ–°é«˜
        const obv10 = obvValues.slice(Math.max(0, index - 10), index);
        const obvHigh = obv10.length > 0 && obvValues[index] > Math.max(...obv10);
        
        // 6. å‰æœŸæœ‰ç¸®é‡æ´—ç›¤
        const hadShrink = detectShrinkPattern(data, index, CONFIG.SHRINK_DAYS);
        
        // ========== åˆ†å±¤è¨Šè™Ÿåˆ¤æ–· ==========
        
        // ğŸŸ¢ å®Œç¾è¨Šè™Ÿï¼ˆåš´æ ¼æ¨¡å¼ï¼‰ï¼šæ‰€æœ‰æ¢ä»¶éƒ½æ»¿è¶³
        const isPerfectSignal = priceUp && volumeUp && volumeSurge && obvHigh && hadShrink;
        
        // ğŸŸ¡ æ¨™æº–è¨Šè™Ÿï¼šåƒ¹å‡é‡å¢ + OBV ä¸Šæš + (æ”¾é‡ æˆ– ç¸®é‡æ´—ç›¤å¾Œ)
        const isStandardSignal = priceUp && volumeUp && obvUp && (volumeSurge || hadShrink);
        
        // âšª åŸºæœ¬è¨Šè™Ÿï¼šåƒ¹å‡é‡å¢ + OBV ä¸Šæš
        const isBasicSignal = priceUp && volumeUp && obvUp;
        
        // æ ¹æ“šæ¨¡å¼é¸æ“‡
        let isGoldenSignal;
        let signalLevel;
        
        if (strictMode) {
            isGoldenSignal = isPerfectSignal;
            signalLevel = isPerfectSignal ? 'perfect' : 'none';
        } else {
            if (isPerfectSignal) {
                isGoldenSignal = true;
                signalLevel = 'perfect';
            } else if (isStandardSignal) {
                isGoldenSignal = true;
                signalLevel = 'standard';
            } else {
                isGoldenSignal = false;
                signalLevel = 'none';
            }
        }
        
        return {
            isGoldenSignal,
            signalLevel,
            conditions: {
                priceUp,
                volumeUp,
                volumeSurge,
                obvUp,
                obvHigh,
                hadShrink
            },
            metrics: {
                priceChangePercent: priceChangePercent.toFixed(2),
                volumeChangePercent: volumeChangePercent.toFixed(2),
                volumeRatio: volumeRatio.toFixed(2),
                obvSlope: obvSlope.toFixed(0)
            }
        };
    }
    
    // ============================================
    // åŸ·è¡Œå›æ¸¬ (ä¿®æ­£ç‰ˆ - å«è¨ºæ–·è³‡è¨Š)
    // ============================================
    async function runBacktest() {
        const stockCode = document.getElementById('stock_code').value.trim();
        const fromDate = document.getElementById('from_date').value;
        const toDate = document.getElementById('to_date').value;
        const resultDiv = document.getElementById('backtest-result');
        const btn = document.getElementById('backtest-btn');
        
        if (!stockCode || !fromDate || !toDate) {
            resultDiv.innerHTML = '<div class="error-msg">è«‹å¡«å¯«å®Œæ•´çš„è‚¡ç¥¨ä»£ç¢¼å’Œæ—¥æœŸç¯„åœ</div>';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'â³ å›æ¸¬ä¸­...';
        resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨ç²å–æ•¸æ“šä¸¦è¨ˆç®—...</div>';
        
        try {
            // ç²å–è‚¡ç¥¨æ•¸æ“š
            const data = await fetchStockData(stockCode, fromDate, toDate);
            
            if (!data || data.length < 30) {
                throw new Error('æ•¸æ“šä¸è¶³ï¼Œè«‹ç¢ºèªè‚¡ç¥¨ä»£ç¢¼æ­£ç¢ºä¸”æ—¥æœŸç¯„åœè‡³å°‘ 30 å€‹äº¤æ˜“æ—¥');
            }
            
            // è¨ˆç®— OBV
            const obvValues = calculateOBV(data);
            
            // è¨ºæ–·çµ±è¨ˆ
            const diagnostics = {
                totalDays: data.length,
                priceUpDays: 0,
                volumeUpDays: 0,
                volumeSurgeDays: 0,
                obvUpDays: 0,
                obvHighDays: 0,
                shrinkPatternDays: 0
            };
            
            // æƒææ‰€æœ‰è¨Šè™Ÿ
            const signals = [];
            const allResults = []; // ç”¨æ–¼è¨ºæ–·
            
            for (let i = 21; i < data.length - CONFIG.HOLDING_DAYS; i++) {
                const result = detectGoldenSignal(data, obvValues, i, false); // ä½¿ç”¨å¯¬é¬†æ¨¡å¼
                
                if (result) {
                    // çµ±è¨ˆå„æ¢ä»¶æ»¿è¶³æ¬¡æ•¸
                    if (result.conditions.priceUp) diagnostics.priceUpDays++;
                    if (result.conditions.volumeUp) diagnostics.volumeUpDays++;
                    if (result.conditions.volumeSurge) diagnostics.volumeSurgeDays++;
                    if (result.conditions.obvUp) diagnostics.obvUpDays++;
                    if (result.conditions.obvHigh) diagnostics.obvHighDays++;
                    if (result.conditions.hadShrink) diagnostics.shrinkPatternDays++;
                    
                    if (result.isGoldenSignal) {
                        // è¨ˆç®—æŒæœ‰ N å¤©å¾Œçš„å ±é…¬
                        const entryPrice = data[i].close;
                        const exitPrice = data[i + CONFIG.HOLDING_DAYS].close;
                        const returnRate = (exitPrice - entryPrice) / entryPrice;
                        
                        signals.push({
                            date: data[i].date,
                            entryPrice,
                            exitPrice,
                            returnRate,
                            win: returnRate > 0,
                            signalLevel: result.signalLevel,
                            metrics: result.metrics
                        });
                    }
                }
            }
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalSignals = signals.length;
            const perfectSignals = signals.filter(s => s.signalLevel === 'perfect').length;
            const standardSignals = signals.filter(s => s.signalLevel === 'standard').length;
            const wins = signals.filter(s => s.win).length;
            const winRate = totalSignals > 0 ? (wins / totalSignals * 100).toFixed(1) : 0;
            const avgReturn = totalSignals > 0 
                ? (signals.reduce((sum, s) => sum + s.returnRate, 0) / totalSignals * 100).toFixed(2) 
                : 0;
            
            // è¨ˆç®—æœ€å¤§å›æ’¤
            let peak = 1;
            let maxDrawdown = 0;
            let cumReturn = 1;
            
            for (const signal of signals) {
                cumReturn *= (1 + signal.returnRate);
                if (cumReturn > peak) peak = cumReturn;
                const drawdown = (peak - cumReturn) / peak;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            }
            
            // è¨ˆç®—è¨ºæ–·ç™¾åˆ†æ¯”
            const scanDays = data.length - 21 - CONFIG.HOLDING_DAYS;
            
            // æ¸²æŸ“çµæœ
            resultDiv.innerHTML = `
                <div class="backtest-result">
                    <h3 style="margin-bottom: 15px;">ğŸ“Š å›æ¸¬çµæœï¼š${stockCode}</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                        æœŸé–“ï¼š${fromDate} è‡³ ${toDate} | äº¤æ˜“æ—¥ï¼š${data.length} å¤© | æŒæœ‰å¤©æ•¸ï¼š${CONFIG.HOLDING_DAYS} å¤©
                    </p>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="value blue">${totalSignals}</div>
                            <div class="label">ç¸½è¨Šè™Ÿæ•¸</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ğŸŸ¢ å®Œç¾: ${perfectSignals} | ğŸŸ¡ æ¨™æº–: ${standardSignals}
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="value ${parseFloat(winRate) >= 60 ? 'green' : parseFloat(winRate) >= 50 ? 'blue' : 'red'}">${winRate}%</div>
                            <div class="label">å‹ç‡</div>
                        </div>
                        <div class="result-item">
                            <div class="value ${parseFloat(avgReturn) >= 0 ? 'green' : 'red'}">${avgReturn}%</div>
                            <div class="label">å¹³å‡å ±é…¬</div>
                        </div>
                        <div class="result-item">
                            <div class="value red">${(maxDrawdown * 100).toFixed(1)}%</div>
                            <div class="label">æœ€å¤§å›æ’¤</div>
                        </div>
                    </div>
                    
                    <!-- è¨ºæ–·è³‡è¨Š -->
                    <div class="strategy-box" style="margin-top: 20px;">
                        <h3>ğŸ” æ¢ä»¶è¨ºæ–·ï¼ˆå„æ¢ä»¶æ»¿è¶³å¤©æ•¸ï¼‰</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--accent-green);">${diagnostics.priceUpDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">åƒ¹å‡å¤©æ•¸</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${(diagnostics.priceUpDays/scanDays*100).toFixed(0)}%</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--accent-green);">${diagnostics.volumeUpDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">é‡å¢å¤©æ•¸</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${(diagnostics.volumeUpDays/scanDays*100).toFixed(0)}%</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: ${diagnostics.volumeSurgeDays > 10 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${diagnostics.volumeSurgeDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">çˆ†é‡å¤©æ•¸</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">>${CONFIG.VOLUME_SURGE_RATIO}xå‡é‡</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: var(--accent-blue);">${diagnostics.obvUpDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">OBVä¸Šæš</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${(diagnostics.obvUpDays/scanDays*100).toFixed(0)}%</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: ${diagnostics.obvHighDays > 10 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${diagnostics.obvHighDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">OBVæ–°é«˜</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">è¿‘10æ—¥é«˜</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--bg-card); border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: 600; color: ${diagnostics.shrinkPatternDays > 20 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${diagnostics.shrinkPatternDays}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">ç¸®é‡æ´—ç›¤</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">${(diagnostics.shrinkPatternDays/scanDays*100).toFixed(0)}%</div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                            ğŸ’¡ è¨Šè™Ÿæ¢ä»¶ï¼š(åƒ¹å‡ + é‡å¢ + OBVä¸Šæš) + (çˆ†é‡ æˆ– ç¸®é‡æ´—ç›¤å¾Œ)
                        </p>
                    </div>
                    
                    ${totalSignals > 0 ? `
                        <div class="strategy-box" style="margin-top: 15px;">
                            <h3>ğŸ“‹ æœ€è¿‘ 10 ç­†è¨Šè™Ÿæ˜ç´°</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; font-size: 12px; margin-top: 10px; min-width: 500px;">
                                    <tr style="border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                        <th style="padding: 8px; text-align: left;">æ—¥æœŸ</th>
                                        <th style="padding: 8px; text-align: center;">ç­‰ç´š</th>
                                        <th style="padding: 8px; text-align: right;">é€²å ´åƒ¹</th>
                                        <th style="padding: 8px; text-align: right;">å‡ºå ´åƒ¹</th>
                                        <th style="padding: 8px; text-align: right;">å ±é…¬</th>
                                        <th style="padding: 8px; text-align: right;">é‡æ¯”</th>
                                    </tr>
                                    ${signals.slice(-10).reverse().map(s => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 8px;">${s.date}</td>
                                            <td style="padding: 8px; text-align: center;">
                                                <span class="signal-tag ${s.signalLevel === 'perfect' ? 'green' : 'yellow'}" style="font-size: 10px;">
                                                    ${s.signalLevel === 'perfect' ? 'ğŸŸ¢ å®Œç¾' : 'ğŸŸ¡ æ¨™æº–'}
                                                </span>
                                            </td>
                                            <td style="padding: 8px; text-align: right;">${s.entryPrice.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right;">${s.exitPrice.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: right; color: ${s.win ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                                ${s.win ? '+' : ''}${(s.returnRate * 100).toFixed(2)}%
                                            </td>
                                            <td style="padding: 8px; text-align: right; color: var(--text-secondary);">${s.metrics.volumeRatio}x</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                    ` : `
                        <div class="error-msg" style="margin-top: 15px; background: rgba(255, 214, 0, 0.1); border-color: var(--accent-yellow); color: var(--accent-yellow);">
                            âš ï¸ åœ¨æ­¤æœŸé–“æœªç™¼ç¾ç¬¦åˆæ¢ä»¶çš„è¨Šè™Ÿã€‚<br><br>
                            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                            â€¢ è©²è‚¡ç¥¨æ³¢å‹•è¼ƒå°ï¼Œä¸å¸¸å‡ºç¾ã€Œç¸®é‡â†’æ”¾é‡ã€æ¨¡å¼<br>
                            â€¢ å¯å˜—è©¦ï¼šå»¶é•·å›æ¸¬æœŸé–“ã€æ›´æ›ä¸­å°å‹è‚¡ã€èª¿æ•´åƒæ•¸<br><br>
                            <strong>è¨ºæ–·å»ºè­°ï¼š</strong>æŸ¥çœ‹ä¸Šæ–¹å„æ¢ä»¶æ»¿è¶³æ¬¡æ•¸ï¼Œæ‰¾å‡ºç“¶é ¸æ‰€åœ¨
                        </div>
                    `}
                    
                    <div style="margin-top: 15px; padding: 12px; background: var(--bg-dark); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                        <strong>âš ï¸ å›æ¸¬é™åˆ¶ï¼š</strong><br>
                        â€¢ æ­¤å›æ¸¬æœªè¨ˆå…¥äº¤æ˜“æˆæœ¬ï¼ˆæ‰‹çºŒè²»ç´„ 0.1425%ã€è­‰äº¤ç¨… 0.3%ï¼‰<br>
                        â€¢ ç¼ºå°‘ä¸‰å¤§æ³•äººå³æ™‚è²·è³£è¶…æ•¸æ“š<br>
                        â€¢ éå»ç¸¾æ•ˆä¸ä»£è¡¨æœªä¾†è¡¨ç¾
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('å›æ¸¬éŒ¯èª¤:', error);
            resultDiv.innerHTML = `
                <div class="error-msg">
                    âŒ å›æ¸¬å¤±æ•—ï¼š${error.message}<br><br>
                    å¯èƒ½åŸå› ï¼š<br>
                    â€¢ è‚¡ç¥¨ä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼ˆå°è‚¡è«‹ç”¨ 2330.TW æ ¼å¼ï¼‰<br>
                    â€¢ ç¶²è·¯é€£ç·šå•é¡Œæˆ– CORS é™åˆ¶<br>
                    â€¢ æ—¥æœŸç¯„åœå…§ç„¡äº¤æ˜“æ•¸æ“š
                </div>
            `;
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸš€ åŸ·è¡Œå›æ¸¬';
        }
    }
    
    // ============================================
    // ç²å–è‚¡ç¥¨æ•¸æ“šï¼ˆä½¿ç”¨ CORS proxyï¼‰
    // ============================================
    async function fetchStockData(symbol, fromDate, toDate) {
        const period1 = Math.floor(new Date(fromDate).getTime() / 1000);
        const period2 = Math.floor(new Date(toDate).getTime() / 1000);
        
        // Yahoo Finance API URL
        const yahooUrl = `${CONFIG.YAHOO_BASE}${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
        
        // å˜—è©¦å¤šå€‹ CORS proxy
        let lastError = null;
        
        for (const proxy of CONFIG.CORS_PROXIES) {
            try {
                const url = proxy + encodeURIComponent(yahooUrl);
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const json = await response.json();
                const result = json.chart?.result?.[0];
                
                if (!result || !result.timestamp) {
                    throw new Error('ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼');
                }
                
                // è§£ææ•¸æ“š
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];
                
                const data = [];
                for (let i = 0; i < timestamps.length; i++) {
                    if (quotes.close[i] && quotes.volume[i]) {
                        data.push({
                            date: new Date(timestamps[i] * 1000).toISOString().split('T')[0],
                            open: quotes.open[i],
                            high: quotes.high[i],
                            low: quotes.low[i],
                            close: quotes.close[i],
                            volume: quotes.volume[i]
                        });
                    }
                }
                
                return data;
                
            } catch (error) {
                console.warn(`Proxy ${proxy} å¤±æ•—:`, error.message);
                lastError = error;
                continue;
            }
        }
        
        throw new Error(lastError?.message || 'æ‰€æœ‰æ•¸æ“šæºéƒ½ç„¡æ³•é€£æ¥');
    }
    
    // ============================================
    // ç·¨è¼¯æ¨¡å¼åˆ‡æ›
    // ============================================
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const container = document.getElementById('container');
        const btn = document.getElementById('edit-toggle');
        
        container.classList.toggle('editing', isEditMode);
        btn.classList.toggle('active', isEditMode);
        btn.textContent = isEditMode ? 'âœ“ å®Œæˆç·¨è¼¯' : 'âš™ï¸ ç·¨è¼¯æ’åº';
        
        if (isEditMode && !sortableInstance) {
            sortableInstance = new Sortable(container, {
                animation: 200,
                ghostClass: 'dragging',
                onEnd: function() {
                    // å„²å­˜æ’åºåˆ° localStorage
                    const order = Array.from(container.children).map(el => el.id);
                    localStorage.setItem('sectionOrder', JSON.stringify(order));
                }
            });
        }
    }
    
    // ============================================
    // æ›´æ–° Banner æ™‚é–“
    // ============================================
    function updateBanner() {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            weekday: 'long'
        };
        const dateStr = now.toLocaleDateString('zh-TW', options);
        const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('current-date').textContent = dateStr;
        document.getElementById('current-time').textContent = ` ${timeStr}`;
    }
    
    // ============================================
    // åˆå§‹åŒ–
    // ============================================
    function init() {
        console.log('ğŸ“Š çµ„åˆæ‹³æƒæå™¨åˆå§‹åŒ–ä¸­...');
        
        // æ›´æ–° Banner
        updateBanner();
        setInterval(updateBanner, 60000);
        
        // è¼‰å…¥å€å¡Šé †åº
        const savedOrder = localStorage.getItem('sectionOrder');
        let orderedSections = sections;
        
        if (savedOrder) {
            try {
                const order = JSON.parse(savedOrder);
                orderedSections = order
                    .map(id => sections.find(s => s.id === id))
                    .filter(Boolean);
                // åŠ å…¥å¯èƒ½æ–°å¢çš„å€å¡Š
                sections.forEach(s => {
                    if (!orderedSections.find(os => os.id === s.id)) {
                        orderedSections.push(s);
                    }
                });
            } catch (e) {
                console.warn('è®€å–æ’åºè¨­å®šå¤±æ•—', e);
            }
        }
        
        // æ¸²æŸ“å€å¡Š
        const container = document.getElementById('container');
        orderedSections.forEach(section => {
            const div = document.createElement('div');
            div.className = 'section';
            div.id = section.id;
            div.innerHTML = `
                <h2><span class="icon">${section.icon}</span> ${section.title}</h2>
                <div class="content">${section.render()}</div>
            `;
            container.appendChild(div);
        });
        
        console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å•Ÿå‹•
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
